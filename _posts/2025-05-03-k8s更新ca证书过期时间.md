---
title: k8s更新ca证书过期时间
date: 2025-05-03 22:35:00 +0800
categories: [k8s,k8s更新ca证书过期时间]
tags: [k8s,k8s更新ca证书过期时间]
---

##### 一、
.crt：per格式的证书
.der: der格式的证书
.key：pem格式的私钥
.pub：pem格式的公钥
.req：申请证书时发送给CA认证机构的请求文件
.csr：申请证书时发送给CA认证机构的请求文件 

证书 = 公钥 + 申请者与颁发者信息 + 签名
证书文件的后缀并不能作为证书是哪一种编码的判断依据，对于公私钥的文件后缀有时是key,pem....重要的是文件的内容格式
证书分为2种类型，2种类型本质上没区别
1、CA证书(CA certficate)
2、终端实体证书，接受ca证书的最终实体

###### 1、生成ca的私钥
[root@master pki]# openssl genrsa -out ca.key 2048
Generating RSA private key, 2048 bit long modulus
...................................+++
...............+++
e is 65537 (0x10001)
[root@master pki]# ls
ca.key

###### 2、生成ca证书请求文件，回车后需要输入一系列基本信息
[root@master pki]# openssl req -new -key ca.key -out ca.csr
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:cn				#国家
State or Province Name (full name) []:cn				#省/自治区
Locality Name (eg, city) [Default City]:xa				#城市
Organization Name (eg, company) [Default Company Ltd]:ky	#组织
Organizational Unit Name (eg, section) []:ky			#组织单位
Common Name (eg, your name or your server's hostname) []:ky	#通用名称
Email Address []:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:root.2020				#邀请密码
An optional company name []:ky				#公司(可选)
[root@master pki]# ls
ca.csr  ca.key

###### 3、生成ca证书
[root@master pki]# openssl x509 -req -days 3650 -in ca.csr -signkey ca.key -out ca.crt
Signature ok
subject=/C=cn/ST=cn/L=xa/O=ky/OU=ky/CN=ky
Getting Private key
[root@master pki]# ls
ca.crt  ca.csr  ca.key

###### 4、将上面生成的ca.crt作为根证书，来签发一个新证书，密钥和申请的请求文件和上面一致
[root@master pki]# openssl genrsa -out server.key 1024
Generating RSA private key, 1024 bit long modulus
.++++++
..................................................................................++++++
e is 65537 (0x10001)

[root@master pki]# openssl req -new -key server.key -out server.csr
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:cn
State or Province Name (full name) []:sx
Locality Name (eg, city) [Default City]:xa
Organization Name (eg, company) [Default Company Ltd]:
Organizational Unit Name (eg, section) []:
Common Name (eg, your name or your server's hostname) []:
Email Address []:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:

[root@master pki]# openssl x509 -req -days 300 -CA ca.crt -CAkey ca.key -CAserial ca.srl -CAcreateserial -in server.csr -out server.crt
Signature ok
subject=/C=cn/ST=sx/L=xa/O=Default Company Ltd
Getting CA Private Key

    -CA：指定CA证书的路径

    -CAkey：指定 CA 证书的私钥路径

    -CAserial：指定证书序列号文件的路径

    -CAcreateserial：表示创建证书序列号文件（即上方提到的 serial 文件），创建的序列号文件默认名称为 -CA，指定的证书名称后加上 .srl 后缀
[root@master pki]# ls
ca.crt  ca.csr  ca.key  ca.srl  server.crt  server.csr  server.key
证书校验，查看是否签发成功
[root@master pki]# openssl verify -CAfile ca.crt server.crt 
server.crt: OK

-------------------------------------------------------------------------------------------------------------------
##### 二、手动更新证书
随着 kubernetes 集群的使用，某一天证书过期了，此时 kubernetes 集群将无法正常使用，比如：kubectl 命令执行会产生错误（You must be logged in to the server(unauthorized)）、通过 k8s 接口访问资源时出现“证书过期”的错误等。

###### 1、查看证书是否过期
openssl x509 -in *.crt -noout -text | grep -i not
[root@master pki]# openssl x509 -in /etc/kubernetes/pki/ca.crt -noout -text | grep -i not
            Not Before: Dec 28 09:40:14 2023 GMT
            Not After : Dec 25 09:40:14 2033 GMT
[root@master pki]# openssl x509 -in apiserver.crt -noout -text | grep -i not
            Not Before: Dec 28 09:40:14 2023 GMT
            Not After : Dec 27 09:40:14 2024 GMT

如果是使用kubeadm部署的集群，可以使用`kubeadm  certs check-expiration`命令查看证书到期时间。1.19版本之前使用`kubeadm alpha certs check-expiration`
```
[root@master ~]# kubeadm  certs check-expiration
[check-expiration] Reading configuration from the cluster...
[check-expiration] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'

CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
admin.conf                 Apr 07, 2025 06:41 UTC   364d            ca                      no      
apiserver                  Apr 07, 2025 06:41 UTC   364d            ca                      no      
apiserver-etcd-client      Apr 07, 2025 06:41 UTC   364d            etcd-ca                 no      
apiserver-kubelet-client   Apr 07, 2025 06:41 UTC   364d            ca                      no      
controller-manager.conf    Apr 07, 2025 06:41 UTC   364d            ca                      no      
etcd-healthcheck-client    Apr 07, 2025 06:41 UTC   364d            etcd-ca                 no      
etcd-peer                  Apr 07, 2025 06:41 UTC   364d            etcd-ca                 no      
etcd-server                Apr 07, 2025 06:41 UTC   364d            etcd-ca                 no      
front-proxy-client         Apr 07, 2025 06:41 UTC   364d            front-proxy-ca          no      
scheduler.conf             Apr 07, 2025 06:41 UTC   364d            ca                      no      

CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
ca                      Dec 30, 2033 16:06 UTC   9y              no      
etcd-ca                 Dec 30, 2033 16:06 UTC   9y              no      
front-proxy-ca          Dec 30, 2033 16:06 UTC   9y              no 
```
上面的列表中没有包含 kubelet.conf，因为 kubeadm 将 kubelet 配置为自动更新证书。 轮换的证书位于目录 /var/lib/kubelet/pki。

###### 2、更新证书前备份集群的证书和配置
kubeadm config view > kubeadm-cluster.yaml 
cp -rp /etc/kubernetes/ /etc/kubernetes.bak
cp -rp /var/lib/etcd /var/lib/etcd.bak

###### 3、更新证书
使用`kubeadm  certs renew all`更新证书，这个命令将更新所有证书，并自动更新kubeconfig文件和各种配置文件。1.19版本之前使用`kubeadm alpha certs renew all`
如果你运行了一个 HA 集群，这个命令需要在所有控制面板节点上执行。
```
[root@master ~]# kubeadm  certs renew all
[renew] Reading configuration from the cluster...
[renew] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'

certificate embedded in the kubeconfig file for the admin to use and for kubeadm itself renewed
certificate for serving the Kubernetes API renewed
certificate the apiserver uses to access etcd renewed
certificate for the API server to connect to kubelet renewed
certificate embedded in the kubeconfig file for the controller manager to use renewed
certificate for liveness probes to healthcheck etcd renewed
certificate for etcd nodes to communicate with each other renewed
certificate for serving etcd renewed
certificate for the front proxy client renewed
certificate embedded in the kubeconfig file for the scheduler manager to use renewed

Done renewing certificates. You must restart the kube-apiserver, kube-controller-manager, kube-scheduler and etcd, so that they can use the 
new certificates.
```

###### 4、重启所有master的所有组件
更新证书后需要重启控制面 Pod。因为动态证书重载目前还不被所有组件和证书支持，所有这项操作是必须的。 静态 Pod 是被本地 kubelet 而不是 API 服务器管理，所以 kubectl 不能用来删除或重启他们。 要重启静态 Pod 你可以临时将清单文件从 /etc/kubernetes/manifests/ 移除并等待 20 秒 （参考 KubeletConfiguration 结构中的 fileCheckFrequency 值）。如果 Pod 不在清单目录里，kubelet 将会终止它。 在另一个 fileCheckFrequency 周期之后你可以将文件移回去，kubelet 可以完成 Pod 的重建，而组件的证书更新操作也得以完成。
docker ps | grep -E 'k8s_kube-apiserver|k8s_kube-controller-manager|k8s_kube-scheduler|k8s_etcd_etcd' | awk '{print $1}' | xargs docker restart 

###### 5、更新~/.kube/config文件
sudo mv $HOME/.kube/config $HOME/.kube/config.bak
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config


>注意事项:
更新证书只需在master上更新，node节点上的kubelet证书默认自动轮换更新，无需关心过期问题
执行k8s版本升级也会自动更新证书
更新证书可能会导致短暂的服务中断
更新证书前，做好关机数据备份

###### 6、更新kubelet.conf
默认情况下，kubeadm 使用 /etc/kubernetes/kubelet.conf 中指定的 /var/lib/kubelet/pki/kubelet-client-current.pem 符号链接来配置 kubelet 自动轮换客户端证书。如果此轮换过程失败，你可能会在 kube-apiserver 日志中看到诸如 x509: certificate has expired or is not yet valid 之类的错误。要解决此问题，你必须执行以下步骤：

    从故障节点备份和删除 /etc/kubernetes/kubelet.conf 和 /var/lib/kubelet/pki/kubelet-client*。
    在集群中具有 /etc/kubernetes/pki/ca.key 的、正常工作的控制平面节点上 执行 kubeadm kubeconfig user --org system:nodes --client-name system:node:$NODE > kubelet.conf。 $NODE 必须设置为集群中现有故障节点的名称。 手动修改生成的 kubelet.conf 以调整集群名称和服务器端点， 或传递 kubeconfig user --config （请参阅为其他用户生成 kubeconfig 文件）。 如果你的集群没有 ca.key，你必须在外部对 kubelet.conf 中的嵌入式证书进行签名。

    将得到的 kubelet.conf 文件复制到故障节点上，作为 /etc/kubernetes/kubelet.conf。
    在故障节点上重启 kubelet（systemctl restart kubelet），等待 /var/lib/kubelet/pki/kubelet-client-current.pem 重新创建。

    手动编辑 kubelet.conf 指向轮换的 kubelet 客户端证书，方法是将 client-certificate-data 和 client-key-data 替换为：

    client-certificate: /var/lib/kubelet/pki/kubelet-client-current.pem
    client-key: /var/lib/kubelet/pki/kubelet-client-current.pem

    重新启动 kubelet。
    确保节点状况变为 Ready

即admin.conf中的client-certificate-data 与 client-key-data  替换kubelet.conf文件的client-certificate 与 client-key
重启 kubelet（systemctl restart kubelet），等待 /var/lib/kubelet/pki/kubelet-client-current.pem 重新创建。再将配置文件改回去
    client-certificate: /var/lib/kubelet/pki/kubelet-client-current.pem
    client-key: /var/lib/kubelet/pki/kubelet-client-current.pem
再重启 kubelet