---
title: lvm丢失问题
date: 2023-09-09 22:34:00 +0800
categories: [linux,lvm丢失问题]
tags: [linux,lvm丢失问题]
---


重启机器发现系统起不来
执行lvs，pvs，vgs告警
WARNING: lvmetad is running but disabled. Restart lvmetad before enabling it
问题：执行pvs发现pv丢失
root@KPF001:~# pvs
  WARNING: Device for PV dKEWCR-yjNC-RXmf-k0xY-YfEp-4bDA-eJBVy6 not found or rejected by a filter.



一、查看lvm的backup文件 cat /etc/lvm/backup/<vgname>
```shell
[deployer@Jxxx ~]$ sudo cat /etc/lvm/backup/vg1
# Generated by LVM2 version 2.02.180(2)-RHEL7 (2018-07-20): Sat May 28 00:45:21 2022

contents = "Text Format Volume Group"
version = 1

description = "Created *after* executing 'lvcreate -l 100%FREE -n lv_apps vg1'"	#这里可以看到创建lvm时的命令

creation_host = "JNSC-PSC-P13F16-MDMZ-VM-OS01-CMP-HARBOR-01"	# Linux x-Vx 4.19.25-200.1.el7.linux.x86_64 #1 SMP Mon Aug 19 14:46:26 CST 2019 x86_64
creation_time = 1653669921	# Sat May 28 00:45:21 2022

vg1 {
	id = "DSEo5h-RIks-akKA-oKL6-RZbh-1dhL-nTKuvB"
	seqno = 2
	format = "lvm2"			# informational
	status = ["RESIZEABLE", "READ", "WRITE"]
	flags = []
	extent_size = 8192		# 4 Megabytes
	max_lv = 0
	max_pv = 0
	metadata_copies = 0

	physical_volumes {

		pv0 {
			id = "4MlNob-05MS-3LQ8-V8D5-kKqx-sCAH-gDQaQq"
			device = "/dev/vdb1"	# Hint only

			status = ["ALLOCATABLE"]
			flags = []
			dev_size = 1048571904	# 499.998 Gigabytes
			pe_start = 2048
			pe_count = 127999	# 499.996 Gigabytes
		}
	}

	logical_volumes {

		lv_apps {
			id = "hy1QOB-A4rH-yzsh-qmf0-fGC5-oHlo-CL1Sj2"
			status = ["READ", "WRITE", "VISIBLE"]
			flags = []
			creation_time = 1653669921	# 2022-05-28 00:45:21 +0800
			creation_host = "x-VM-xxx"
			segment_count = 1

			segment1 {
				start_extent = 0
				extent_count = 127999	# 499.996 Gigabytes

				type = "striped"
				stripe_count = 1	# linear

				stripes = [
					"pv0", 0
				]
			}
		}
	}

}
```

二、如果创建pv时使用的不是整个盘而是一个分区则需要先创建分区
如果使用的是整个盘则可以省略这一步
fdisk /dev/vdb 进行分区，起始扇区和结束扇区必须和原来保持一致

三、恢复pv
pvcreate <disk> --uuid <UUID> --restorefile <metadata-file> 

pvcreate /dev/sdb -u 【physical_volums中pv0中的id，而且是丢失的逻辑卷（盘）的】 --restorefile /etc/lvm/backup/xxx
```shell
[deployer@xx ~]$ sudo pvcreate /dev/vdb1 -u  4MlNob-05MS-3LQ8-V8D5-kKqx-sCAH-gDQaQq --restorefile /etc/lvm/backup/vg1
  WARNING: Couldn't find device with uuid 4MlNob-05MS-3LQ8-V8D5-kKqx-sCAH-gDQaQq.
  Physical volume "/dev/vdb1" successfully created.
```
四、恢复vg
vgcfgrestore --file <metadata-file> <vg-name>
vgcfgrestore <vgname>

```shell
[deployer@xx ~]$ sudo vgcfgrestore vg1
```
五、查看是否已恢复
vgs && pvs && lvs 

六、激活vg
vgchange -ay <vgname>
```shell
[deployer@xx ~]$ vgchange -ay  vg1
```